# RunTheMatrix, cmsDriver, and cmsRun
This section introduces the runTheMatrix, cmsDriver and cmsRun commands/utilities for CMSSW, with some useful recipies and commands.

## Intro to runTheMatrix
runTheMatrix allows to pick and choose a workflow using its designated number. The workflow includes a series of conditions (e.g. Phase-2, geometry, era, PU, ecc.). For workflows whose number does not end with .0, process modifiers are also included. For example, the Phase-2 changes to HLT muon reconstruction are found in all workflows ending with .777 (Inside-Out reconstruction first) and .778 (Outside-In reconstruction first) (SingleMuon, TTbar, and ZMM).
The basic approach to runTheMatrix is listing all available workflows
```bash
runTheMatrix.py -w upgrade -n | grep <workflow>
```
(Some) options
- `-w` tells the matrix which set of workflows to look through (here, Phase-2)
- `-n` only lists the workflows without executing
- `-e` show the detailed cmsDriver commands for the specified workflow
- `-l` comma separated list of the workflows to run or show
- `-t NTHREADS` specifies the number of threads to be used per process in cmsRun
- `-j 0` only creates the python configuration files without executing them
- `--maxSteps N` executes the workflow only up to the specified step (e.g. `--maxSteps 2` will run step1 and step2, meaning GEN-SIM and L1-HLT reconstruction, but no offline reconstruction or harvesting). This option also saves the `cmsDriver` commands for the following steps in a `wf_steps.txt` file

For example
```bash
runTheMatrix.py -w upgrade -n -e -l 29850.0 
```
lists all the steps for workflow `29850.0` without executing them.
One can execute them by simply copy-pasting the cmsDriver commands listed one after the other or by using `runTheMatrix` without the `-n` option.

`runTheMatrix` generates (and by default runs) a series of python configuration files. Each of them is specifically generated by a `cmsDriver.py` command which lists all the conditions and modifiers to apply.
Take the workflow `29850.777` as an example. It corresponds to a Phase-2 ZMM sample with 200 PU, the `.777` modifier introduces the improved L2 Muon seeding from L1 Tracker Muons and attempts L3 Tracker Muon reconstruction Inside-Out first.

The full name of the workflow is: `29850.777 ZMM_14TeV_TuneCP5_2026D110PU_GenSimHLBeamSpot14+DigiTriggerPU_phase2L2AndL3MuonsIOFirst_2026D110PU+RecoGlobalPU_phase2L2AndL3MuonsIOFirst_2026D110PU+HARVESTGlobalPU_phase2L2AndL3MuonsIOFirst_2026D110PU`

```bash
runTheMatrix.py -w upgrade -n -e -l 29850.777
```
produces the following output (note the `-n` to only generate the configuration files and not run them)
<details>
<summary> output </summary>

```bash 
[1]: cmsDriver.py
ZMM_14TeV_TuneCP5_cfi
-s GEN,SIM
-n 10
--conditions auto:phase2_realistic_T33
--beamspot DBrealisticHLLHC
--datatier GEN-SIM
--eventcontent FEVTDEBUG
--geometry Extended2026D110
--era Phase2C17I13M9
--relval 18000,100 

[2]: cmsDriver.py step2
-s DIGI:pdigi_valid,L1TrackTrigger,L1,L1P2GT,DIGI2RAW,HLT:@relval2026
--conditions auto:phase2_realistic_T33
--datatier GEN-SIM-DIGI-RAW
-n 10
--eventcontent FEVTDEBUGHLT
--geometry Extended2026D110
--era Phase2C17I13M9
--procModifiers phase2L2AndL3Muons
--pileup AVE_200_BX_25ns
--pileup_input das:/RelValMinBias_14TeV/CMSSW_14_1_0_pre5-140X_mcRun4_realistic_v4_RegeneratedGS_2026D110_noPU-v1/GEN-SIM

[3]: cmsDriver.py step3  
-s RAW2DIGI,RECO,RECOSIM,PAT,VALIDATION:@phase2Validation+@miniAODValidation,DQM:@phase2+@miniAODDQM
--conditions auto:phase2_realistic_T33
--datatier GEN-SIM-RECO,MINIAODSIM,DQMIO
-n 10
--eventcontent FEVTDEBUGHLT,MINIAODSIM,DQM
--geometry Extended2026D110
--era Phase2C17I13M9
--procModifiers phase2L2AndL3Muons
--pileup AVE_200_BX_25ns
--pileup_input das:/RelValMinBias_14TeV/CMSSW_14_1_0_pre5-140X_mcRun4_realistic_v4_RegeneratedGS_2026D110_noPU-v1/GEN-SIM

[4]: cmsDriver.py step4 
-s HARVESTING:@phase2Validation+@phase2+@miniAODValidation+@miniAODDQM
--conditions auto:phase2_realistic_T33 
--mc 
--geometry Extended2026D110 
--scenario pp 
--filetype DQM 
--era Phase2C17I13M9 
--procModifiers phase2L2AndL3Muons 
-n 10 
--pileup AVE_200_BX_25ns 
--pileup_input das:/RelValMinBias_14TeV/CMSSW_14_1_0_pre5-140X_mcRun4_realistic_v4_RegeneratedGS_2026D110_noPU-v1/GEN-SIM
```

</details>

## cmsDriver recipes
The `cmsDriver.py` command is used to generate the python configuration files for the CMSSW processes. The command can be used to generate configurations for different steps of the workflow, such as GEN, DIGI, RECO, etc.
In general, I mostly use the command to run or re-run the HLT step on a given sample (possibly from RelVals), usually running validation at the same time. In this case, it is important to specify a few specific options to ensure that the pre-mixed PU is used correctly and that the HLT objects in the input file are not accessed by the new process. Therefore, this is the typical recipe:
```bash
cmsDriver.py step2 -s L1P2GT,HLT:75e33,VALIDATION:@hltValidation \
--conditions auto:phase2_realistic_T33 \
--datatier GEN-SIM-DIGI-RAW,DQMIO \
-n 1000 \
--eventcontent FEVTDEBUGHLT,DQMIO \
--geometry ExtendedRun4D110 \
--era Phase2C17I13M9 \
--filein file:/eos/cms/store/relval/CMSSW_15_1_0_pre3/RelValTTbar_14TeV/GEN-SIM-DIGI-RAW/PU_150X_mcRun4_realistic_v1_STD_Run4D110_PU-v1/2590000/00c675dc-1517-4af7-8dd4-841e0668fefe.root \
--fileout file:step2.root \
--process HLTX \
--inputCommands='keep *, drop *_hlt*_*_HLT, drop triggerTriggerFilterObjectWithRefs_l1t*_*_HLT'
```
Note that there is no DIGI step in this command, since the input file already contains the DIGI information with PU. Furthermore, the `--inputCommands` option is used to drop the HLT objects from the input file, so that they are not accessed by the new process. The `--process` option is used to specify a different process name (HLTX) to avoid conflicts with the original HLT process.
Finally, to harvest the DQM plots, one can use the following command:
```bash
cmsDriver.py step5 -s HARVESTING:@hltValidation \
--conditions auto:phase2_realistic_T33 \
--mc \
--geometry ExtendedRun4D110 \
--scenario pp \
--filetype DQM \
--era Phase2C17I13M9 \
-n -1  \
--filein file:step2_inDQM.root
```
## Process all relVals in a folder
When processing multiple files from the same directory there is a simple way to list them all using python (on a machine which has `/eos` mounted):

```python
import os
# ZMM PU
source_path = '/eos/cms/store/relval/CMSSW_15_0_0_pre2/RelValZMM_14/GEN-SIM-DIGI-RAW/PU_141X_mcRun4_realistic_v3_STD_Run4D110_PU-v1/2590000/'

files = []
for path in os.listdir(source_path):
    if os.path.isfile(os.path.join(source_path, path)):
        files.append('file:' + os.path.join(source_path, path))
```

In this way, passing `files` as the input in the source module of CMSSW will make the entire list of files available to the process (setting the number of events to process to -1 might result in long execution times ðŸ™‚)
